{% extends "base.html" %}

{% block title %}Analyze Server - WhatDoesThisBoxDo{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Analyze Server</h1>
    <p>Enter server connection details or select stored credentials</p>
</div>

<div class="form-container">
    <form method="POST" class="analyze-form">
        <div class="form-section">
            <h3>Saved Credentials</h3>
            <div class="form-group">
                <label for="saved_credential">Use Saved Credential</label>
                <select id="saved_credential" name="saved_credential">
                    <option value="">-- Enter manually --</option>
                </select>
                <small>Select a saved credential or enter details manually below</small>
            </div>
        </div>

        <div class="form-section" id="manual-section">
            <h3>Connection Details</h3>

            <div class="form-group">
                <label for="hostname">Hostname / IP Address <span class="required">*</span></label>
                <input type="text" id="hostname" name="hostname" placeholder="192.168.1.100 or server.example.com">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="port">Port</label>
                    <input type="number" id="port" name="port" value="22" min="1" max="65535">
                </div>
                <div class="form-group">
                    <label for="os_type">Operating System</label>
                    <select id="os_type" name="os_type">
                        <option value="linux">Linux (SSH)</option>
                        <option value="windows">Windows (WinRM)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-section" id="auth-section">
            <h3>Authentication</h3>

            <div class="form-group">
                <label for="username">Username <span class="required">*</span></label>
                <input type="text" id="username" name="username" placeholder="root or administrator">
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="Enter password">
                <small>Leave empty if using SSH key</small>
            </div>

            <div class="form-group" id="ssh-key-group">
                <label for="ssh_key">SSH Private Key Path</label>
                <input type="text" id="ssh_key" name="ssh_key" placeholder="/home/user/.ssh/id_rsa">
                <small>Path to SSH private key file on this server</small>
            </div>
        </div>

        <div class="form-section">
            <h3>Analysis Options</h3>

            <div class="form-row">
                <div class="form-group">
                    <label for="monitor_duration">Metrics Collection Duration (seconds)</label>
                    <input type="number" id="monitor_duration" name="monitor_duration" value="0" min="0" max="600" step="10">
                    <small>Collect real-time CPU, memory, and I/O metrics (0 = disabled, recommended: 30-120 seconds)</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" name="generate_ansible" value="1" checked>
                        Generate Ansible playbooks
                    </label>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" name="generate_ansible_full" value="1" checked>
                        Generate full Ansible recreation playbooks
                    </label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" name="generate_terraform" value="1" checked>
                        Generate Terraform configs (vSphere)
                    </label>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" name="generate_cloud" value="1" checked>
                        Generate cloud configs (AWS, GCP, Azure)
                    </label>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                <span class="btn-icon">&#9654;</span>
                Start Analysis
            </button>
        </div>
    </form>
</div>

<div class="info-box">
    <h4>Note</h4>
    <ul>
        <li>For Linux servers, ensure SSH is enabled and accessible</li>
        <li>For Windows servers, ensure WinRM is configured (default port: 5985/5986)</li>
        <li>The account should have sufficient privileges to gather system information</li>
        <li>Analysis typically takes 1-3 minutes depending on system complexity</li>
        <li>Save credentials in the <a href="{{ url_for('admin_credentials') }}">Admin area</a> for quick access</li>
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load saved credentials
fetch('/api/credentials')
    .then(response => response.json())
    .then(credentials => {
        const select = document.getElementById('saved_credential');
        credentials.forEach(cred => {
            const option = document.createElement('option');
            option.value = cred.id;
            option.textContent = cred.hostname ? `${cred.name} (${cred.hostname})` : cred.name;
            option.dataset.hostname = cred.hostname || '';
            option.dataset.port = cred.port || '';
            option.dataset.osType = cred.os_type || 'linux';
            select.appendChild(option);
        });
    })
    .catch(err => console.log('No saved credentials available'));

// Handle saved credential selection
document.getElementById('saved_credential').addEventListener('change', function() {
    const authSection = document.getElementById('auth-section');
    const selectedOption = this.options[this.selectedIndex];

    if (this.value) {
        // Using saved credential - only gray out authentication fields
        authSection.style.opacity = '0.5';
        authSection.querySelectorAll('input').forEach(input => input.disabled = true);

        // Pre-fill connection details from credential defaults (if set)
        if (selectedOption.dataset.hostname) {
            document.getElementById('hostname').value = selectedOption.dataset.hostname;
        }
        if (selectedOption.dataset.port) {
            document.getElementById('port').value = selectedOption.dataset.port;
        }
        document.getElementById('os_type').value = selectedOption.dataset.osType || 'linux';

        // Update port based on OS if no default port set
        if (!selectedOption.dataset.port) {
            if (selectedOption.dataset.osType === 'windows') {
                document.getElementById('port').value = '5985';
            } else {
                document.getElementById('port').value = '22';
            }
        }
    } else {
        // Manual entry - enable all fields
        authSection.style.opacity = '1';
        authSection.querySelectorAll('input').forEach(input => input.disabled = false);
    }
});

// Handle OS type change
document.getElementById('os_type').addEventListener('change', function() {
    const port = document.getElementById('port');
    const sshKeyGroup = document.getElementById('ssh-key-group');

    if (this.value === 'windows') {
        port.value = '5985';
        sshKeyGroup.style.display = 'none';
    } else {
        port.value = '22';
        sshKeyGroup.style.display = 'block';
    }
});
</script>
{% endblock %}
