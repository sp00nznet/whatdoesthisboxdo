{% extends "base.html" %}

{% block title %}{{ 'Edit' if credential else 'Add' }} Credential - WhatDoesThisBoxDo{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ 'Edit' if credential else 'Add' }} Credential</h1>
</div>

<div class="form-container" style="max-width: 600px;">
    <form method="POST" class="credential-form" enctype="multipart/form-data">
        <div class="form-group">
            <label for="name">Credential Name *</label>
            <input type="text" id="name" name="name" value="{{ credential.name if credential else '' }}" required placeholder="e.g., Linux Root, Windows Admin">
            <small>A friendly name to identify this credential set</small>
        </div>

        <div class="form-group">
            <label for="username">Username *</label>
            <input type="text" id="username" name="username" value="{{ credential.username if credential else '' }}" required placeholder="root">
        </div>

        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" placeholder="{{ '********' if credential and credential.password else 'Enter password' }}">
            {% if credential and credential.password %}
            <small>Leave blank to keep existing password</small>
            {% else %}
            <small>Required if not using SSH key</small>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="ssh_key_file">SSH Private Key</label>
            {% if credential and credential.has_ssh_key %}
            <div class="existing-key-notice">
                <span class="key-icon">ðŸ”‘</span> SSH key already stored
                <label class="replace-key-label">
                    <input type="checkbox" id="replace_key" name="replace_key" value="1"> Replace with new key
                </label>
            </div>
            <input type="file" id="ssh_key_file" name="ssh_key_file" accept=".pem,.key,.pub,*" style="display: none;">
            {% else %}
            <input type="file" id="ssh_key_file" name="ssh_key_file" accept=".pem,.key,.pub,*">
            {% endif %}
            <small>Upload your SSH private key file (e.g., id_rsa, id_ed25519)</small>
        </div>

        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0;">

        <h4 style="margin-bottom: 1rem; color: #64748b;">Default Connection Settings (Optional)</h4>
        <p style="font-size: 0.875rem; color: #64748b; margin-bottom: 1rem;">
            These are optional defaults. You can override them when analyzing a server.
        </p>

        <div class="form-row">
            <div class="form-group">
                <label for="hostname">Default Hostname / IP</label>
                <input type="text" id="hostname" name="hostname" value="{{ credential.hostname if credential else '' }}" placeholder="(optional)">
            </div>
            <div class="form-group" style="max-width: 120px;">
                <label for="port">Default Port</label>
                <input type="number" id="port" name="port" value="{{ credential.port if credential else 22 }}" min="1" max="65535">
            </div>
        </div>

        <div class="form-group">
            <label for="os_type">Operating System</label>
            <select id="os_type" name="os_type">
                <option value="linux" {{ 'selected' if not credential or credential.os_type == 'linux' else '' }}>Linux (SSH)</option>
                <option value="windows" {{ 'selected' if credential and credential.os_type == 'windows' else '' }}>Windows (WinRM)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="2" placeholder="Optional notes about this credential">{{ credential.description if credential else '' }}</textarea>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{{ 'Update' if credential else 'Save' }} Credential</button>
            <a href="{{ url_for('admin_credentials') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<style>
.form-row {
    display: flex;
    gap: 1rem;
}
.form-row .form-group {
    flex: 1;
}
.existing-key-notice {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: #ecfdf5;
    border: 1px solid #a7f3d0;
    border-radius: 6px;
    margin-bottom: 0.5rem;
}
.key-icon {
    font-size: 1.25rem;
}
.replace-key-label {
    margin-left: auto;
    font-size: 0.875rem;
    color: #64748b;
    cursor: pointer;
}
.replace-key-label input {
    margin-right: 0.25rem;
}
input[type="file"] {
    padding: 0.5rem;
    border: 2px dashed #cbd5e1;
    border-radius: 6px;
    width: 100%;
    cursor: pointer;
}
input[type="file"]:hover {
    border-color: #94a3b8;
    background: #f8fafc;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const replaceKeyCheckbox = document.getElementById('replace_key');
    const sshKeyFileInput = document.getElementById('ssh_key_file');

    if (replaceKeyCheckbox && sshKeyFileInput) {
        replaceKeyCheckbox.addEventListener('change', function() {
            sshKeyFileInput.style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                sshKeyFileInput.value = '';
            }
        });
    }
});
</script>
{% endblock %}
