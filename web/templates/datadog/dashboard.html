{% extends "base.html" %}

{% block title %}Datadog Integration - WhatDoesThisBoxDo{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Datadog Integration</h1>
    <p>Analyze servers using Datadog metrics and monitoring data</p>
</div>

{% if not datadog_available %}
<div class="alert alert-warning">
    Datadog connector is not available. Check that all dependencies are installed.
</div>
{% endif %}

<div class="dashboard-grid">
    <div class="card">
        <h3>Quick Actions</h3>
        <div class="button-group">
            <a href="{{ url_for('datadog_analyze') }}" class="btn btn-primary">Analyze Server</a>
            <a href="{{ url_for('datadog_containerize') }}" class="btn btn-primary">Containerization Planner</a>
            <a href="{{ url_for('admin_datadog') }}" class="btn btn-secondary">Manage Credentials</a>
        </div>
    </div>

    <div class="card">
        <h3>Saved Credentials</h3>
        {% if credentials %}
        <ul class="credential-list">
            {% for cred in credentials %}
            <li>
                <strong>{{ cred.name }}</strong>
                <span class="badge">{{ cred.site }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted">No saved credentials. <a href="{{ url_for('admin_add_datadog_credential') }}">Add one</a>.</p>
        {% endif %}
    </div>
</div>

<div class="section">
    <h2>Open Insights</h2>
    {% if open_insights %}
    <table class="table">
        <thead>
            <tr>
                <th>Severity</th>
                <th>Hostname</th>
                <th>Title</th>
                <th>Category</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for insight in open_insights %}
            <tr>
                <td>
                    <span class="badge badge-{{ 'danger' if insight.severity == 'critical' else 'warning' if insight.severity == 'warning' else 'info' }}">
                        {{ insight.severity }}
                    </span>
                </td>
                <td><code>{{ insight.hostname }}</code></td>
                <td>{{ insight.title }}</td>
                <td>{{ insight.category }}</td>
                <td>{{ insight.created_at }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="{{ url_for('datadog_insights') }}" class="btn btn-secondary">View All Insights</a>
    {% else %}
    <p class="text-muted">No open insights.</p>
    {% endif %}
</div>

<div class="section">
    <h2>Recent Analyses</h2>
    {% if recent_analyses %}
    <table class="table">
        <thead>
            <tr>
                <th>Hostname</th>
                <th>Health Score</th>
                <th>Server Types</th>
                <th>Issues</th>
                <th>Analyzed</th>
            </tr>
        </thead>
        <tbody>
            {% for analysis in recent_analyses %}
            <tr>
                <td><code>{{ analysis.hostname }}</code></td>
                <td>
                    <span class="badge badge-{{ 'success' if analysis.health_score >= 80 else 'warning' if analysis.health_score >= 50 else 'danger' }}">
                        {{ analysis.health_score }}%
                    </span>
                </td>
                <td>{{ analysis.server_types|join(', ') if analysis.server_types else '-' }}</td>
                <td>
                    {% if analysis.critical_count > 0 %}
                    <span class="badge badge-danger">{{ analysis.critical_count }} critical</span>
                    {% endif %}
                    {% if analysis.warning_count > 0 %}
                    <span class="badge badge-warning">{{ analysis.warning_count }} warnings</span>
                    {% endif %}
                </td>
                <td>{{ analysis.created_at }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="{{ url_for('datadog_history') }}" class="btn btn-secondary">View Full History</a>
    {% else %}
    <p class="text-muted">No analyses yet. <a href="{{ url_for('datadog_analyze') }}">Analyze a server</a> to get started.</p>
    {% endif %}
</div>

<div class="section">
    <h2>Learned Patterns</h2>
    {% if patterns %}
    <table class="table">
        <thead>
            <tr>
                <th>Pattern</th>
                <th>Type</th>
                <th>Occurrences</th>
                <th>Confidence</th>
                <th>Last Seen</th>
            </tr>
        </thead>
        <tbody>
            {% for pattern in patterns %}
            <tr>
                <td>{{ pattern.description[:60] }}{% if pattern.description|length > 60 %}...{% endif %}</td>
                <td><span class="badge">{{ pattern.pattern_type }}</span></td>
                <td>{{ pattern.occurrence_count }}</td>
                <td>{{ "%.0f"|format(pattern.confidence * 100) }}%</td>
                <td>{{ pattern.last_seen }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="{{ url_for('datadog_patterns') }}" class="btn btn-secondary">View All Patterns</a>
    {% else %}
    <p class="text-muted">No patterns learned yet. Patterns are discovered during analysis.</p>
    {% endif %}
</div>
{% endblock %}
