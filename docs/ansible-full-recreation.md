# Full System Recreation with Ansible

This guide explains how to use the comprehensive Ansible playbooks generated by the system analyzer to fully recreate a server.

## Overview

The `ansible-full/` directory contains a complete Ansible project that can recreate every aspect of the analyzed system:

- User accounts with passwords
- Group memberships
- Installed packages
- Running services
- Docker containers
- Filesystem structure
- Mount points
- Cron jobs
- Network configuration
- Firewall rules
- System configuration files

## Generated Structure

```
ansible-full/
├── site.yml              # Main playbook (runs all roles)
├── inventory             # Host inventory
├── ansible.cfg           # Ansible configuration
├── deploy.sh             # Deployment script
├── dryrun.sh             # Dry-run script
├── check-syntax.sh       # Syntax validation script
├── README.md             # Quick reference
├── group_vars/
│   └── all.yml           # Global variables - CUSTOMIZE THIS
├── host_vars/
│   └── <hostname>.yml    # Host-specific variables
├── roles/
│   ├── base/             # Base system configuration
│   ├── users/            # User account management
│   ├── groups/           # Group management
│   ├── packages/         # Package installation
│   ├── services/         # Service management
│   ├── firewall/         # UFW firewall configuration
│   ├── mounts/           # Filesystem mounts
│   ├── directories/      # Directory structure
│   ├── docker/           # Docker installation & containers
│   ├── cron/             # Cron job configuration
│   ├── network/          # Network configuration
│   └── configs/          # System configuration files
├── files/                # Static files to copy
└── templates/            # Jinja2 templates
```

## Quick Start

### 1. Review Variables

Before deployment, review and customize the variables in `group_vars/all.yml`:

```bash
cd output/<hostname>/ansible-full/
vim group_vars/all.yml
```

Key variables to review:

| Variable | Description |
|----------|-------------|
| `target_host` | IP or hostname of target server |
| `ansible_user` | SSH user for connection |
| `system_users` | List of users to create |
| `apt_packages` | Packages to install |
| `services_to_enable` | Services to enable |
| `firewall_allowed_tcp_ports` | Ports to open |
| `docker_enabled` | Whether to install Docker |
| `mount_points` | Filesystem mounts |
| `cron_jobs` | Scheduled tasks |

### 2. Check Syntax

```bash
./check-syntax.sh
```

### 3. Dry Run

Test without making changes:

```bash
./dryrun.sh <target_host>
# or
ansible-playbook -i inventory site.yml -e "target_host=<ip>" --check --diff
```

### 4. Deploy

```bash
./deploy.sh <target_host>
# or
ansible-playbook -i inventory site.yml -e "target_host=<ip>"
```

## Role Reference

### base

Sets up basic system configuration:
- Hostname
- Timezone
- Locale
- Sysctl parameters
- /etc/hosts entries

### groups

Creates system groups:

```yaml
system_groups:
  - name: developers
    gid: 2000
  - name: operations
```

### users

Creates users with full configuration:

```yaml
system_users:
  - name: john
    uid: 1001
    groups: ['sudo', 'docker', 'developers']
    shell: /bin/bash
    password_hash: '$6$...'  # from /etc/shadow
    authorized_keys:
      - "ssh-rsa AAAA... john@example.com"
    sudo: true
    shell_configs:
      - .bashrc
      - .bash_profile
```

### packages

Installs packages from multiple sources:

```yaml
apt_packages:
  - nginx
  - postgresql
  - redis-server

pip_packages:
  - flask
  - gunicorn

npm_global_packages:
  - pm2
  - yarn

snap_packages:
  - certbot
```

### services

Manages systemd services:

```yaml
services_to_enable:
  - nginx
  - postgresql
  - redis-server

services_to_start:
  - nginx
  - postgresql
```

Custom unit files can be placed in `roles/services/files/*.service`.

### firewall

Configures UFW firewall:

```yaml
firewall_enabled: true
firewall_default_policy: deny
firewall_allow_ssh: true
ssh_port: 22

firewall_allowed_tcp_ports:
  - 80
  - 443
  - 5432

firewall_allowed_udp_ports:
  - 53

firewall_allowed_ranges:
  - from: 10.0.0.0/8
    port: 22
    proto: tcp
    comment: Internal SSH
```

### mounts

Configures filesystem mounts:

```yaml
mount_points:
  - path: /mnt/data
    src: /dev/sdb1
    fstype: ext4
    opts: defaults

  - path: /mnt/nfs
    src: nfs-server:/export
    fstype: nfs
    opts: rw,sync

  - path: /mnt/share
    src: //server/share
    fstype: cifs
    opts: username=user,password=pass
```

### directories

Creates directory structures:

```yaml
create_directories:
  - path: /opt/apps
    owner: root
    group: root
    mode: '0755'

  - path: /srv/data
    owner: www-data
    group: www-data
    mode: '0775'
    recurse: true
```

### docker

Installs and configures Docker:

```yaml
docker_enabled: true
docker_users:
  - deploy
  - john

docker_networks:
  - name: app-network
    driver: bridge

docker_volumes:
  - name: postgres-data
  - name: redis-data

docker_containers:
  - name: nginx
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/www:/usr/share/nginx/html:ro
    restart_policy: unless-stopped

  - name: postgres
    image: postgres:15
    env:
      POSTGRES_PASSWORD: secret
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - app-network
```

### cron

Sets up scheduled tasks:

```yaml
cron_jobs:
  - name: Daily backup
    hour: '2'
    minute: '0'
    job: /opt/scripts/backup.sh

  - name: Log cleanup
    hour: '3'
    minute: '0'
    weekday: '0'
    job: find /var/log -name "*.log" -mtime +30 -delete

  - name: Health check
    minute: '*/5'
    job: /opt/scripts/health-check.sh
```

Files in `roles/cron/files/cron.d/` will be copied to `/etc/cron.d/`.

### network

Configures network settings:

```yaml
hosts_entries:
  - ip: 10.0.0.10
    hostname: db-master
    aliases: db

dns_servers:
  - 8.8.8.8
  - 8.8.4.4

static_routes:
  - dest: 192.168.0.0/16
    gateway: 10.0.0.1
    interface: eth0
```

Netplan files can be placed in `roles/network/files/netplan/*.yaml`.

### configs

Manages system configuration files:

```yaml
configure_sshd: true
ssh_permit_root_login: prohibit-password
ssh_password_authentication: false
ssh_pubkey_authentication: true
ssh_port: 22

sysctl_params:
  - name: net.core.somaxconn
    value: '65535'
  - name: vm.swappiness
    value: '10'

config_files:
  - src: nginx.conf
    dest: /etc/nginx/nginx.conf
    notify: restart nginx
```

## Running Specific Roles

Use tags to run specific roles:

```bash
# Base configuration only
ansible-playbook -i inventory site.yml --tags "base"

# Users and groups only
ansible-playbook -i inventory site.yml --tags "users"

# Packages only
ansible-playbook -i inventory site.yml --tags "packages"

# Docker only
ansible-playbook -i inventory site.yml --tags "docker"

# Firewall only
ansible-playbook -i inventory site.yml --tags "firewall"

# Filesystem (directories + mounts)
ansible-playbook -i inventory site.yml --tags "filesystem"

# Network configuration
ansible-playbook -i inventory site.yml --tags "network"

# Cron jobs
ansible-playbook -i inventory site.yml --tags "cron"

# System configs
ansible-playbook -i inventory site.yml --tags "configs"
```

## Individual Playbooks

Run individual playbooks for specific tasks:

```bash
ansible-playbook -i inventory base.yml
ansible-playbook -i inventory users.yml
ansible-playbook -i inventory packages.yml
ansible-playbook -i inventory docker.yml
ansible-playbook -i inventory network.yml
ansible-playbook -i inventory filesystem.yml
ansible-playbook -i inventory cron.yml
ansible-playbook -i inventory configs.yml
```

## Adding Custom Files

### Static Files

Place files in `roles/<role>/files/` and reference them in tasks:

```yaml
- copy:
    src: my-config.conf
    dest: /etc/my-app/config.conf
```

### Templates

Place Jinja2 templates in `roles/<role>/templates/`:

```yaml
- template:
    src: my-config.conf.j2
    dest: /etc/my-app/config.conf
```

## Password Handling

### User Passwords

To set user passwords, you need the password hash from `/etc/shadow`:

```yaml
system_users:
  - name: john
    password_hash: '$6$rounds=656000$salthere$hashedpassword'
```

Generate a password hash:

```bash
# On the source server
sudo grep 'john' /etc/shadow | cut -d: -f2

# Or generate new
mkpasswd --method=sha-512 'password'
```

### Vault Encryption

For sensitive data, use Ansible Vault:

```bash
# Create encrypted vars file
ansible-vault create group_vars/vault.yml

# Edit encrypted file
ansible-vault edit group_vars/vault.yml

# Run with vault
ansible-playbook -i inventory site.yml --ask-vault-pass
```

## Troubleshooting

### Check Connectivity

```bash
ansible -i inventory all -m ping
```

### Verbose Output

```bash
ansible-playbook -i inventory site.yml -vvv
```

### Debug Variables

```bash
ansible -i inventory all -m debug -a "var=hostvars"
```

### Common Issues

**SSH Key Issues:**
```bash
# Ensure key permissions
chmod 600 ~/.ssh/id_rsa

# Test SSH manually
ssh -i ~/.ssh/id_rsa user@host
```

**Sudo Issues:**
```bash
# Run with sudo password
ansible-playbook -i inventory site.yml --ask-become-pass
```

**Package Installation Failures:**
```bash
# Update apt cache first
ansible-playbook -i inventory site.yml --tags "packages" -e "apt_update_cache=true"
```

## Security Notes

1. **Review all variables** before deployment
2. **Change default passwords** immediately
3. **Update SSH authorized keys** to current team members
4. **Review firewall rules** for your environment
5. **Test in staging** before production deployment
6. **Use Ansible Vault** for sensitive data
7. **Audit generated configs** for security best practices
